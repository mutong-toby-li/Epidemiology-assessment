---
title: "Epidemiology Assessment"
author: "Mutong Li"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#0.Preamble: Load packages

```{r}
library(tidyverse)   # Data wrangling and plotting
library(lubridate)   # Date handling
library(janitor)     # Clean variable names, tabulations
```

#1.Data Import & Inspection

```{r}
## Import data (adjust depending on file type)
### Example for CSV:
data <- read_csv("data.csv") %>%
  clean_names()  # make variable names consistent (snake_case)

### Quick inspection
glimpse(data)
summary(data)
```

#2. Data Cleaning

```{r}
## Ensure report_date is Date
data <- data %>%
  mutate(report_date = as.Date(report_date))

## Check missingness
colSums(is.na(data))

```

#3. Descriptive Analysis

```{r}
## Basic counts
data %>%
  count(sex)

## Counts by ethnicity (or other categorical variable)
data %>%
  count(ethnicity) %>%
  mutate(prop = n / sum(n))

## Summary by group
data %>%
  group_by(sex) %>%
  summarise(n = n(),
            mean_age = mean(age, na.rm = TRUE),
            median_age = median(age, na.rm = TRUE))

## Time series counts (if applicable)
cases_by_week <- data %>%
  mutate(week = floor_date(report_date, "week")) %>%
  count(week)

cases_by_week

cases_by_week <- data %>%
  mutate(week = floor_date(report_date, "week")) %>%
  count(week)

##Time Trends
ggplot(cases_by_week, aes(x = week, y = n)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_point(color = "steelblue") +
  labs(title = "Weekly Case Counts",
       x = "Week",
       y = "Number of Cases") +
  theme_minimal(base_size = 12)

## Incidence rate per 100,000
data_rates <- data %>%
  group_by(area) %>%
  summarise(cases = n()) %>%
  left_join(pop_data, by = "area") %>%
  mutate(rate_per_100k = (cases / population) * 100000)

## Example: average age of cases by sex and ethnicity
data %>%
  group_by(sex, ethnicity) %>%
  summarise(n = n(),
            mean_age = mean(age, na.rm = TRUE),
            .groups = "drop")

## Direct standardisation example using {epitools}
library(epitools)

## Suppose counts by age group and population denominators are available
std <- ageadjust.direct(count = cases_by_age$cases,
                        pop = cases_by_age$population,
                        stdpop = std_pop$population)

std$adj.rate   ### gives age-standardised rate

## Example: outcome is hospitalisation (yes/no)
model <- glm(hospitalised ~ sex + ethnicity + deprivation_quintile + age,
             data = data,
             family = binomial)

summary(model)


##Inequalities Analysis
### Cases by deprivation quintile
ggplot(data, aes(x = factor(imd_quintile))) +
  geom_bar(fill = "tomato") +
  labs(title = "Cases by Deprivation Quintile",
       x = "IMD Quintile (1 = most deprived)",
       y = "Number of Cases") +
  theme_minimal(base_size = 12)

### Proportion of cases by ethnicity
data %>%
  count(ethnicity) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = reorder(ethnicity, -prop), y = prop)) +
  geom_col(fill = "darkorange") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Proportion of Cases by Ethnicity",
       x = "Ethnicity",
       y = "Proportion of Cases") +
  theme_minimal(base_size = 12)

### Age Group Distribution
ggplot(data, aes(x = age_group)) +
  geom_bar(fill = "seagreen") +
  labs(title = "Cases by Age Group",
       x = "Age Group",
       y = "Number of Cases") +
  theme_minimal(base_size = 12)
```

#4. Visualisation

```{r}
## Epidemic curve
ggplot(cases_by_week, aes(x = week, y = n)) +
  geom_col(fill = "forestgreen") +
  labs(title = "Cases by Week",
       x = "Week of report",
       y = "Number of cases") +
  theme_minimal()

## Categorical distribution
ggplot(data, aes(x = sex)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Cases by Sex",
       x = "Sex",
       y = "Number of cases") +
  theme_minimal()

## Bar chart of cases by deprivation quintile
ggplot(data, aes(x = deprivation_quintile)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Cases by Deprivation Quintile",
       x = "IMD Quintile (1=most deprived)",
       y = "Number of cases") +
  theme_minimal()

## Rates by ethnicity (if denominator available)
ggplot(data_rates, aes(x = ethnicity, y = rate_per_100k)) +
  geom_col(fill = "tomato") +
  labs(title = "Incidence Rates by Ethnicity",
       x = "Ethnicity",
       y = "Rate per 100,000") +
  theme_minimal()
```

#5.Specific analysis

```{r}

##Time trends (like a surveillance chart):
ggplot(cases_by_week, aes(x = week, y = n)) +
  geom_line(color = "steelblue", linewidth = 1.2) +
  geom_point(color = "steelblue") +
  labs(title = "Weekly case counts",
       x = "Week of report",
       y = "Number of cases") +
  theme_minimal(base_size = 12)

##Rates by deprivation quintile (health inequalities):
ggplot(data_rates, aes(x = factor(deprivation_quintile), y = rate_per_100k)) +
  geom_col(fill = "tomato") +
  labs(title = "Incidence rate by deprivation quintile",
       x = "IMD Quintile (1 = most deprived)",
       y = "Rate per 100,000") +
  theme_minimal(base_size = 12)

##Ethnicity breakdown (proportions):
data %>%
  count(ethnicity) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = reorder(ethnicity, -prop), y = prop)) +
  geom_col(fill = "darkorange") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Proportion of cases by ethnicity",
       x = "Ethnicity",
       y = "Proportion") +
  theme_minimal(base_size = 12) +
  coord_flip()
```
